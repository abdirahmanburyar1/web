// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  PLATFORM_ADMIN
  TENANT_ADMIN
  STAFF
  COLLECTOR
  ACCOUNTANT
}

enum PaymentMethod {
  CASH
  MOBILE_MONEY
  BANK_TRANSFER
  OTHER
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  PENDING
}

enum SubscriptionPlan {
  BASIC
  STANDARD
  PREMIUM
  ENTERPRISE
}

enum PlatformPaymentStatus {
  PENDING
  PAID
  FAILED
}

enum MeterStatus {
  PENDING
  ACTIVE
  SUSPENDED
  OVERDUE
  INACTIVE
}

// Platform Models

model PlanLimit {
  plan             SubscriptionPlan @id
  maxStaff         Int?
  maxCustomers     Int?
  maxTransactions  Int?

  @@map("plan_limits")
}

model PlatformSetting {
  id    String @id @default(uuid())
  key   String @unique
  value Json

  @@map("platform_settings")
}

model PlatformPayment {
  id          String                @id @default(uuid())
  tenantId    String
  tenant      Tenant                @relation(fields: [tenantId], references: [id])
  amount      Decimal                @db.Decimal(10, 2)
  currency    String                 @default("USD")
  status      PlatformPaymentStatus @default(PENDING)
  description String?
  paidAt      DateTime?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  receipts    PlatformReceipt[]

  @@map("platform_payments")
  @@index([tenantId])
}

model PlatformReceipt {
  id                 String         @id @default(uuid())
  platformPaymentId String
  platformPayment   PlatformPayment @relation(fields: [platformPaymentId], references: [id])
  receiptNumber     String?
  url               String?         // e.g. link to stored file
  issuedAt          DateTime        @default(now())
  createdAt         DateTime       @default(now())

  @@map("platform_receipts")
  @@index([platformPaymentId])
}

model Tenant {
  id                String           @id @default(uuid())
  name              String
  slug              String           @unique
  status            TenantStatus     @default(ACTIVE)
  subscriptionPlan  SubscriptionPlan @default(BASIC)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  // Settings
  billingCycle      String?          // e.g., "monthly", "quarterly"
  currency          String           @default("USD")
  // Platform fee per payment (USD), e.g. 0.2 per payment
  feePerPayment     Decimal          @db.Decimal(5, 4) @default(0.2)
  // Plan limits (null = unlimited)
  maxStaff          Int?
  maxCustomers      Int?
  maxTransactions   Int?             // per billing period

  // Relations
  users             User[]
  roles             Role[]
  prices            Price[]
  meters            Meter[]
  zones             Zone[]
  sections          Section[]
  subSections       SubSection[]
  invoices          Invoice[]
  payments          Payment[]
  platformPayments  PlatformPayment[]
  auditLogs         AuditLog[]

  @@map("tenants")
}

model Price {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  name          String   // e.g. "Residential", "Commercial", "Default"
  pricePerCubic Decimal  @db.Decimal(10, 4) // per m³
  isDefault     Boolean  @default(false)    // one default per tenant for meters without a price
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  meters        Meter[]

  @@map("prices")
  @@index([tenantId])
}

model User {
  id             String    @id @default(uuid())
  tenantId       String?
  tenant         Tenant?   @relation(fields: [tenantId], references: [id])
  roleId         String?
  role           Role?     @relation(fields: [roleId], references: [id])
  
  email          String    @unique
  username       String?   // system-generated sequential for collectors (e.g. 000001, 000002)
  passwordHash   String
  fullName       String
  phoneNumber    String?
  
  roleType       UserRole  @default(STAFF)  // quick check: PLATFORM_ADMIN, TENANT_ADMIN, etc.
  isActive       Boolean   @default(true)
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relations
  collectedPayments Payment[]   @relation("CollectorPayments")
  metersAssigned    Meter[]     @relation("CollectorMeters")
  directPermissions UserPermission[]
  auditLogs         AuditLog[]
  meterReadings     MeterReading[]

  @@map("users")
  @@index([tenantId])
  @@index([email])
  @@index([roleId])
}

// Permission codes (e.g. customers:read, invoices:manage) - platform-level list
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  module      String?
  rolePerms   RolePermission[]
  userPerms   UserPermission[]

  @@map("permissions")
}

// Tenant-specific roles (admin, staff, collector, or custom)
model Role {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  users       User[]
  permissions RolePermission[]

  @@map("roles")
  @@index([tenantId])
}

model RolePermission {
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id])
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// Direct permission assignment to a user (override/in addition to role)
model UserPermission {
  userId       String
  user         User       @relation(fields: [userId], references: [id])
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id])

  @@id([userId, permissionId])
  @@map("user_permissions")
}

// Tenant Models

model Section {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  description String?

  subSections SubSection[]

  @@map("sections")
  @@index([tenantId])
}

model SubSection {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  sectionId   String?
  section     Section?  @relation(fields: [sectionId], references: [id])
  name        String
  description String?

  zones       Zone[]

  @@map("sub_sections")
  @@index([tenantId])
  @@index([sectionId])
}

model Zone {
  id            String       @id @default(uuid())
  tenantId      String
  tenant        Tenant       @relation(fields: [tenantId], references: [id])
  subSectionId  String?
  subSection    SubSection?  @relation(fields: [subSectionId], references: [id])
  name          String
  description   String?

  meters        Meter[]

  @@map("zones")
  @@index([tenantId])
  @@index([subSectionId])
}

model Meter {
  id                String      @id @default(uuid())
  tenantId          String      @map("tenant_id")
  tenant            Tenant      @relation(fields: [tenantId], references: [id])
  priceId           String?
  price             Price?      @relation(fields: [priceId], references: [id])
  zoneId            String?
  zone              Zone?       @relation(fields: [zoneId], references: [id])
  collectorId       String?
  collector         User?       @relation("CollectorMeters", fields: [collectorId], references: [id])

  meterNumber       String
  customerName      String
  customerPhone     String?
  residentPhone     String?
  section           String?
  subSection        String?
  plateNumber       String?
  status            MeterStatus @default(PENDING)
  address           String?
  meterType         String?
  meterModel        String?
  installationDate  DateTime?
  serialNumber      String?

  createdAt         DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  invoices          Invoice[]
  payments          Payment[]
  meterReadings     MeterReading[]

  @@map("meters")
  @@unique([tenantId, meterNumber])
  @@unique([tenantId, plateNumber])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([meterNumber])
  @@index([plateNumber])
  @@index([zoneId])
  @@index([collectorId])
  @@index([priceId])
}

model MeterReading {
  id            String   @id @default(uuid())
  meterId       String
  meter         Meter    @relation(fields: [meterId], references: [id])
  value         Decimal  @db.Decimal(12, 4)
  unit          String?  @default("m³")
  pricePerCubic Decimal? @db.Decimal(10, 4) // price per m³ at time of reading (from meter or tenant default)
  recordedAt    DateTime @default(now())
  recordedById  String?
  recordedBy    User?    @relation(fields: [recordedById], references: [id])

  @@map("meter_readings")
  @@index([meterId])
  @@index([recordedById])
}

model Invoice {
  id             String    @id @default(uuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id])
  meterId        String
  meter         Meter     @relation(fields: [meterId], references: [id])

  amount         Decimal   @db.Decimal(10, 2)
  balance        Decimal   @db.Decimal(10, 2)
  status         String    @default("PENDING") // PENDING, PAID, PARTIAL, OVERDUE
  dueDate        DateTime
  issuedDate     DateTime  @default(now())
  items          Json?

  payments       Payment[]

  @@map("invoices")
  @@index([tenantId])
  @@index([meterId])
}

model Payment {
  id             String           @id @default(uuid())
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id])
  meterId        String
  meter         Meter             @relation(fields: [meterId], references: [id])
  paymentNumber  String?          // per-tenant sequential e.g. 000001
  invoiceId      String?
  invoice        Invoice?         @relation(fields: [invoiceId], references: [id])
  collectorId    String?
  collector      User?            @relation("CollectorPayments", fields: [collectorId], references: [id])
  amount         Decimal          @db.Decimal(10, 2)
  method         PaymentMethod    @default(CASH)
  reference      String?
  recordedAt     DateTime         @default(now())

  receipts       PaymentReceipt[]

  @@map("payments")
  @@index([tenantId])
  @@index([meterId])
  @@index([collectorId])
  @@index([invoiceId])
}

model PaymentReceipt {
  id              String        @id @default(uuid())
  paymentId       String
  payment         Payment       @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  receiptNumber   String?       // official receipt number (e.g. from receipt book)
  amountReceived  Decimal?      @db.Decimal(10, 2) // amount on this receipt; when null, use payment.amount
  paymentMethod   PaymentMethod? // how this receipt was paid; when null, use payment.method
  url             String?       // e.g. link to scanned receipt
  issuedAt        DateTime     @default(now())
  createdAt       DateTime     @default(now())

  @@map("payment_receipts")
  @@index([paymentId])
}

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String?
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  
  action      String
  entityType  String
  entityId    String?
  details     Json?
  
  createdAt   DateTime @default(now())

  @@map("audit_logs")
  @@index([tenantId])
  @@index([userId])
}
